!function(n,q,D){"use strict";var c="ht",g=n[c],X=g.Default,P=X.def,V=X.getInternal();g.HistoryManager=function(e){this._histories=[],this.setDataModel(e)},P(g.HistoryManager,q,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var H=this;H._betweenTransaction++,1===H._betweenTransaction&&(H._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var t=this,k=t._histories;if(t._betweenTransaction>0&&t._betweenTransaction--,0===t._betweenTransaction){if(t._transactionHistories){var u=[];for(var P in t._transactionHistories)u.push(t._transactionHistories[P]);u.length&&(k=k.slice(0,t._historyIndex+1),k.push(u),k.length>t._maxHistoryCount&&(k=k.slice(k.length-t._maxHistoryCount)),t.setHistories(k),t.setHistoryIndex(k.length-1,!0))}delete t._transactionHistories}}},setDataModel:function(j){var C=this,f=C._dataModel;f!==j&&(f&&(delete f._historyManager,f.ump(C.handleDataModelPropertyChange,C),f.umm(C.$5p,C),f.umd(C.$6p,C),f.removeHierarchyChangeListener(C.handleHierarchyChange,C),f.removeIndexChangeListener(C.handleIndexChange,C)),C._dataModel=j,j&&(j._historyManager=C,j.mp(C.handleDataModelPropertyChange,C),j.mm(C.$5p,C),j.md(C.$6p,C),j.addHierarchyChangeListener(C.handleHierarchyChange,C),j.addIndexChangeListener(C.handleIndexChange,C)),C.fp("dataModel",f,j),C.clear())},setHistoryIndex:function(R,O){var q=this,Y=q._historyIndex,d=q._histories.length;if(-1>R?R=-1:R>=d&&(R=d-1),Y!==R){if(!O){var W=R-Y;W>0?q.$2p(W):0>W&&q.$1p(-W)}q._historyIndex=R,q.fp("historyIndex",Y,R),q.dataModel&&q.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(I){var y=this,q=y._histories,n=y._maxHistoryCount;(!I||0>=I)&&(I=10),n!==I&&(y._maxHistoryCount=I,y.fp("maxHistoryCount",n,I),q.length>I&&y.clear())},cloneValue:function(t){return g.Default.clone(t)},isPropertyUndoable:function(l){return l&&!this.ignoredPropertyMap[l]},isDataModelPropertyUndoable:function(F){return F&&!this.ignoreDataModelPropertyMap[F]},$5p:function(Q){this.handleChange(Q,Q.kind)},$6p:function(i){this.handleChange(i,"property")},handleHierarchyChange:function(e){this.handleChange(e,"hierarchy")},handleIndexChange:function(I){this.handleChange(I,"index")},handleDataModelPropertyChange:function(t){this.handleChange(t,"dataModelProperty")},toChildrenInfo:function(f){var g={};return g.data=f,g.children=[],f.eachChild(function(q){g.children.push(this.toChildrenInfo(q))},this),g},restoreChildren:function(e){var n=e.data;e.children.forEach(function(P){var e=P.data;e.getParent()!==n&&n.addChild(e),this._dataModel.contains(e)||this._dataModel.add(e),this.restoreChildren(P)},this)},handleChange:function($,P){var G=this;if(!(G._disabled||G._isUndoRedoing||X.loadingRefGraph)){var d,n=(G._histories,$.data),S=$.property;if(!n||!(n._refGraph||n instanceof g.RefGraph)){if("property"===P)G.isPropertyUndoable(S,n)&&(d={kind:P,data:n,property:S,oldValue:G.cloneValue($.oldValue,n,S),newValue:G.cloneValue($.newValue,n,S),event:$});else if("hierarchy"===P||"index"===P)d={kind:P,data:n,oldIndex:$.oldIndex,newIndex:$.newIndex,event:$};else if("clear"===P)d={kind:P,json:$.json,event:$};else if("add"===P){if(d={kind:P,data:n,event:$,childrenInfo:this.toChildrenInfo(n),parent:n.getParent()},d.parent){var _=G._dataModel.getSiblings(n);d.siblingsIndex=_.indexOf(n)}n instanceof g.Node&&(d.host=n.getHost(),d.attaches=n.getAttaches()?n.getAttaches().toArray():D),n instanceof g.Edge&&(d.source=n.getSource(),d.target=n.getTarget())}else"remove"===P?d={kind:P,data:n,event:$}:"dataModelProperty"===P&&G.isDataModelPropertyUndoable(S,n)&&(d={kind:P,property:S,oldValue:G.cloneValue($.oldValue,n,S),newValue:G.cloneValue($.newValue,n,S),event:$});G.addHistory(d)}}},addHistory:function(q){var f=this;if(q)if(f._betweenTransaction){var K=(q.data?q.data._id:0)+"_"+q.kind+"_"+q.property;if("property"===q.kind||"dataModelProperty"===q.kind){var F=f._transactionHistories[K];F&&(q.oldValue=F.oldValue)}f._transactionHistories[K]=q}else{var R=f._histories;R=R.slice(0,f._historyIndex+1),R.push([q]),R.length>f._maxHistoryCount&&(R=R.slice(R.length-f._maxHistoryCount)),f.setHistories(R),f.setHistoryIndex(R.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(u){(!u||0>=u)&&(u=1),this.setHistoryIndex(this._historyIndex-u)},$1p:function(M){if(this.canUndo()){var h,r=this,J=r._dataModel,a=r._histories,d=r._historyIndex,Y=0;for(r._isUndoRedoing=!0,X.setIsolating(!0);M>0;){if(d>=0&&d<a.length){Y++,h=a[d],d--;for(var T=h.length-1;T>=0;T--){var L=h[T],C=L.kind,N=L.data,m=L.property,B=L.event,c=this.cloneValue(L.oldValue,N,m);if(L.undo)L.undo();else if("add"===C)J.remove(N,{keepChildren:!0});else if("remove"===C)J.contains(N)||J.add(N,B.rootsIndex,B.datasIndex);else if("clear"===C)J.deserialize(X.clone(L.json));else if("property"===C)if("parent"===m)c?c.addChild(N,B.oldIndex):(N.setParent(c),B.oldIndex>=0&&J.moveTo(N,B.oldIndex));else{var y=null;0===m.indexOf("a:")?(y="attr",m=m.replace("a:","")):0===m.indexOf("s:")?(y="style",m=m.replace("s:","")):0===m.indexOf("f:")&&(y="field",m=m.replace("f:","")),V.setPropertyValue(N,y,m,c)}else if("dataModelProperty"===C){var y=null;0===m.indexOf("a:")?(y="attr",m=m.replace("a:","")):0===m.indexOf("s:")?(y="style",m=m.replace("s:","")):0===m.indexOf("f:")&&(y="field",m=m.replace("f:","")),V.setPropertyValue(J,y,m,c)}else"hierarchy"===C?J.moveTo(N,L.oldIndex):"index"===C&&J.moveToIndex(N,L.oldIndex)}}M--}X.setIsolating(!1),delete r._isUndoRedoing,r.afterUndo(Y)}},afterUndo:function(){},redo:function(E){(!E||0>=E)&&(E=1),this.setHistoryIndex(this._historyIndex+E)},$2p:function(Q){if(this.canRedo()){var T,p=this,R=p._dataModel,z=p._histories,K=p._historyIndex,w=0;for(p._isUndoRedoing=!0,X.setIsolating(!0);Q>0;){if(K>=-1&&K<z.length-1){w++,K++,T=z[K];for(var i=0;i<T.length;i++){var m=T[i],f=m.kind,e=m.data,Y=m.property,q=m.event,h=this.cloneValue(m.newValue,e,Y);if(m.redo)m.redo();else if("add"===f)m.parent&&!e.getParent()&&m.parent.addChild(e,m.siblingsIndex),R.contains(e)||R.add(e,q.rootsIndex,q.datasIndex),this.restoreChildren(m.childrenInfo),e instanceof g.Node&&(e.setHost(m.host),m.attaches&&m.attaches.forEach(function(y){y.setHost(e)})),e instanceof g.Edge&&(e.setSource(m.source),e.setTarget(m.target));else if("remove"===f)R.remove(e);else if("clear"===f)R.clear();else if("property"===f)if("parent"===Y)h?h.addChild(e,q.newIndex):(e.setParent(h),q.newIndex>=0&&R.moveTo(e,q.newIndex));else{var c=null;0===Y.indexOf("a:")?(c="attr",Y=Y.replace("a:","")):0===Y.indexOf("s:")?(c="style",Y=Y.replace("s:","")):0===Y.indexOf("f:")&&(c="field",Y=Y.replace("f:","")),V.setPropertyValue(e,c,Y,h)}else if("dataModelProperty"===f){var c=null;0===Y.indexOf("a:")?(c="attr",Y=Y.replace("a:","")):0===Y.indexOf("s:")?(c="style",Y=Y.replace("s:","")):0===Y.indexOf("f:")&&(c="field",Y=Y.replace("f:","")),V.setPropertyValue(R,c,Y,h)}else"hierarchy"===f?R.moveTo(e,m.newIndex):"index"===f&&R.moveToIndex(e,m.newIndex)}}Q--}X.setIsolating(!1),delete p._isUndoRedoing,this.afterRedo(w)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);